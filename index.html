<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›£è¦–ã‚«ãƒ¡ãƒ©çµ±åˆãƒ‘ãƒãƒ«</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; margin: 0; padding: 10px; background-color: #f0f2f5; color: #333; }
        
        /* ã‚³ãƒ³ãƒ†ãƒŠï¼šPCã§ã¯åºƒãã€ã‚¹ãƒãƒ›ã§ã¯å¹…ã„ã£ã±ã„ã« */
        .container { 
            background: white; 
            padding: 15px; 
            border-radius: 15px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
            width: 95%;
            max-width: 1000px; /* ãƒ‘ã‚½ã‚³ãƒ³ã§æœ€å¤§1000pxã¾ã§æ‹¡å¤§ */
            margin: auto; 
        }

        h1 { color: #1a73e8; font-size: 1.2rem; margin: 10px 0; }
        
        /* æ˜ åƒã‚¨ãƒªã‚¢ï¼š16:9ã®æ¯”ç‡ã‚’ç¶­æŒã—ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ã«æ‹¡å¤§ */
        .video-container { 
            width: 100%; 
            background: #000; 
            position: relative; 
            overflow: hidden; 
            border-radius: 10px; 
            margin-bottom: 15px; 
            display: none;
            aspect-ratio: 16 / 9; /* æ˜ åƒã®æ¯”ç‡ã‚’å›ºå®š */
        }
        iframe { 
            width: 100%; 
            height: 100%; 
            border: none; 
            display: block; 
        }
        
        /* é€šçŸ¥ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: none; flex-direction: column;
            justify-content: center; align-items: center; z-index: 10; color: white;
        }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* æ“ä½œãƒ‘ãƒãƒ«ï¼šãƒœã‚¿ãƒ³é¡ã¯æ¨ªã«åºƒãŒã‚Šã™ããªã„ã‚ˆã†ä¸­å¤®å¯„ã‚Šã«åˆ¶é™ */
        #controls {
            max-width: 600px;
            margin: 15px auto 0;
        }

        .control-row { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 8px; flex-wrap: wrap; }
        .control-label { font-size: 0.85rem; font-weight: bold; color: #1a73e8; min-width: 70px; text-align: right; }
        .btn-group { display: flex; gap: 5px; flex: 1; }
        
        button { padding: 12px; font-size: 14px; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        #startBtn { background-color: #34a853; color: white; width: 100%; max-width: 400px; margin: 20px auto; }
        #stopBtn { background-color: #ea4335; color: white; width: 100%; margin-top: 25px; display: none; }
        
        .btn-cam { background: #673ab7; color: white; flex: 1; }
        .btn-servo { background: #607d8b; color: white; flex: 1; font-size: 11px; }
        .btn-refresh { background: #f4b400; color: white; width: 100%; margin-top: 10px; }
        
        .note { font-size: 11px; color: #666; margin-top: 15px; line-height: 1.4; padding: 0 10px; }

        /* è¿½åŠ ï¼šã‚»ãƒ³ã‚µãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .sensor-section { margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px; position: relative; text-align: left; }
        .vbatt-badge { position: absolute; top: 20px; right: 10px; font-size: 0.8rem; background: #e8f0fe; padding: 4px 10px; border-radius: 5px; color: #1967d2; font-weight: bold; }
        canvas { width: 100% !important; height: auto !important; max-height: 350px; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ  ç›£è¦–ã‚«ãƒ¡ãƒ©çµ±åˆãƒ‘ãƒãƒ«</h1>
        <div id="status" style="font-size: 12px; margin-bottom: 10px;">æ¥ç¶šä¸­...</div>

        <div id="videoWrapper" class="video-container">
            <div id="overlay">
                <div class="spinner"></div>
                <div id="overlayText">ç”»åƒãŒåˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™...</div>
            </div>
            <iframe id="mainPlayer" src=""></iframe>
        </div>

        <button id="startBtn">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã™ã‚‹</button>

        <div id="controls" style="display: none;">
            <div class="control-row">
                <div class="control-label">ã‚«ãƒ¡ãƒ©åˆ‡æ›¿:</div>
                <div class="btn-group">
                    <button class="btn-cam" onclick="sendControl('SWITCH_CAM1')">ã‚«ãƒ¡ãƒ©ï¼‘</button>
                    <button class="btn-cam" onclick="sendControl('SWITCH_CAM2')">ã‚«ãƒ¡ãƒ©ï¼’</button>
                </div>
            </div>
            <div class="control-row">
                <div class="control-label">ã‚µãƒ¼ãƒœå‹•ä½œ:</div>
                <div class="btn-group">
                    <button class="btn-servo" onclick="sendServo(1)">å‹•ä½œ1(30Â°)</button>
                    <button class="btn-servo" onclick="sendServo(2)">å‹•ä½œ2(60Â°)</button>
                    <button class="btn-servo" onclick="sendServo(3)">å‹•ä½œ3(90Â°)</button>
                </div>
            </div>
            <button class="btn-refresh" onclick="refreshVideo()">â™»ï¸ æ˜ åƒå†èª­è¾¼ï¼ˆæ‰‹å‹•ï¼‰</button>
            
            <button id="stopBtn" onclick="stopWatching()">ã‚«ãƒ¡ãƒ©è¦–è´ã‚’çµ‚äº†ã™ã‚‹</button>
            
            <p class="note">âš ï¸ åŒã˜ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§è¦‹ã¦ã„ã‚‹äººãŒã‚«ãƒ¡ãƒ©åˆ‡æ›¿ã™ã‚‹ã¨ã€ã“ã¡ã‚‰ã®ã‚«ãƒ¡ãƒ©ã‚‚åˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™ã€‚</p>

            <div class="sensor-section">
                <div id="vbatt-display" class="vbatt-badge">é›»æ± : --- mV</div>
                <h2 style="font-size: 1rem; color: #1a73e8; margin-bottom: 5px;">ğŸŒ¡ï¸ ç’°å¢ƒã‚»ãƒ³ã‚µãƒ¼å±¥æ­´ (24æ™‚é–“)</h2>
                <canvas id="sensorChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        const BROKER_URL = 'wss://x0a42d28.ala.asia-southeast1.emqxsl.com:8084/mqtt';
        const TOPIC_CONTROL = 'myneco/cam/maneki7/control';
        const TOPIC_URL = 'myneco/cam/maneki7/url_info';
        const SERVO_TOPIC = "rnubnxuhbtdjsm-un-siewuchtus-2026/nudjx";

        let isWatching = false;
        let streamUrl = "";
        let isMyOwnAction = false; 
        let myChart = null; // ã‚°ãƒ©ãƒ•ç”¨

        const client = mqtt.connect(BROKER_URL, { username: 'kanC', password: 'wMAdfBLkQiM2t9D' });
        const servoClient = mqtt.connect('wss://broker.emqx.io:8084/mqtt');

        client.on('connect', () => {
            document.getElementById('status').innerText = 'â— æ¥ç¶šå®Œäº†';
            client.subscribe(TOPIC_URL);
        });

        document.getElementById('startBtn').onclick = () => {
            isWatching = true;
            client.publish(TOPIC_CONTROL, 'START_CAMERA');
            document.getElementById('startBtn').innerText = 'é€šä¿¡çµŒè·¯ã‚’ç¢ºç«‹ä¸­ï¼ˆç´„10ç§’ï¼‰...';
            document.getElementById('startBtn').style.backgroundColor = '#888';
            document.getElementById('startBtn').disabled = true;
        };

        client.on('message', (topic, message) => {
            const data = message.toString();

            if (topic === TOPIC_URL) {
                if (data.startsWith('http')) {
                    streamUrl = data;
                    showVideo(data);
                    isMyOwnAction = false;
                } 
                else if (data === 'FORCE_RELOAD_START') {
                    if (!isMyOwnAction) {
                        showOverlay("ä»–ã®äººãŒæ“ä½œï¼ˆåˆ‡æ›¿/æ›´æ–°ï¼‰ä¸­ã§ã™...");
                    }
                }
            }
        });

        function showVideo(url) {
            const ifr = document.getElementById('mainPlayer');
            ifr.src = url;
            
            document.getElementById('videoWrapper').style.display = 'block';
            document.getElementById('controls').style.display = 'block';
            document.getElementById('stopBtn').style.display = 'block'; 
            document.getElementById('startBtn').style.display = 'none';
            
            hideOverlay();
            updateChart(); // ãƒ“ãƒ‡ã‚ªè¡¨ç¤ºæ™‚ã«ã‚°ãƒ©ãƒ•ã‚‚èª­ã¿è¾¼ã‚€
        }

        function sendControl(cmd) {
            if (cmd.startsWith('SWITCH')) {
                isMyOwnAction = true; 
                showOverlay("ã‚«ãƒ¡ãƒ©åˆ‡æ›¿ä¸­...");
            }
            client.publish(TOPIC_CONTROL, cmd);
        }

        function refreshVideo() {
            isMyOwnAction = true;
            showOverlay("æ˜ åƒã‚’å†èª­è¾¼ä¸­...");
            
            client.publish(TOPIC_CONTROL, 'REFRESH_START');
            const ifr = document.getElementById('mainPlayer');
            ifr.src = ''; 
            setTimeout(() => { ifr.src = streamUrl; }, 500);
            
            setTimeout(() => { 
                if (isMyOwnAction) {
                    hideOverlay();
                    isMyOwnAction = false;
                }
            }, 2000);
        }

        function stopWatching() {
            if (!isWatching) return;
            isWatching = false;
            client.publish(TOPIC_CONTROL, 'STOP_CAMERA');
            setTimeout(() => { location.reload(); }, 500);
        }

        function showOverlay(text) {
            document.getElementById('overlayText').innerText = text;
            document.getElementById('overlay').style.display = 'flex';
        }

        function hideOverlay() {
            document.getElementById('overlay').style.display = 'none';
        }

        function sendServo(num) {
            servoClient.publish(SERVO_TOPIC, num.toString());
        }

        window.addEventListener('beforeunload', () => {
            if (isWatching) client.publish(TOPIC_CONTROL, 'STOP_CAMERA');
        });

        // --- è¿½åŠ ï¼šã‚»ãƒ³ã‚µãƒ¼ã‚°ãƒ©ãƒ•æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯ ---
        async function updateChart() {
            try {
                const response = await fetch('/sensor-data');
                const data = await response.json();
                if (!data.time || data.time.length === 0) return;

                // é›»åœ§ãƒãƒƒã‚¸ã®æ›´æ–°
                if (data.vbatt && data.vbatt.length > 0) {
                    document.getElementById('vbatt-display').innerText = `é›»æ± : ${data.vbatt[data.vbatt.length - 1]} mV`;
                }

                const ctx = document.getElementById('sensorChart').getContext('2d');
                if (myChart) {
                    myChart.data.labels = data.time;
                    myChart.data.datasets[0].data = data.temp;
                    myChart.data.datasets[1].data = data.press;
                    myChart.update('none');
                } else {
                    myChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.time,
                            datasets: [
                                { label: 'æ¸©åº¦ (â„ƒ)', data: data.temp, borderColor: '#ea4335', backgroundColor: '#ea433533', yAxisID: 'y-temp', tension: 0.3, pointRadius: 1 },
                                { label: 'æ°—åœ§ (hPa)', data: data.press, borderColor: '#1a73e8', backgroundColor: '#1a73e833', yAxisID: 'y-press', tension: 0.3, pointRadius: 1 }
                            ]
                        },
                        options: {
                            responsive: true,
                            interaction: { mode: 'index', intersect: false },
                            scales: {
                                'y-temp': { type: 'linear', position: 'left', title: { display: true, text: 'æ¸©åº¦ (â„ƒ)' } },
                                'y-press': { type: 'linear', position: 'right', title: { display: true, text: 'æ°—åœ§ (hPa)' }, grid: { drawOnChartArea: false } }
                            }
                        }
                    });
                }
            } catch (e) { console.error("ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—:", e); }
        }

        // 1åˆ†ã”ã¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­è¾¼
        setInterval(() => { if(isWatching) updateChart(); }, 60000);
    </script>
</body>
</html>
