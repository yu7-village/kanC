<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›£è¦–ã‚«ãƒ¡ãƒ©çµ±åˆãƒ‘ãƒãƒ«</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; margin: 0; padding: 10px; background-color: #f0f2f5; color: #333; }
        .container { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 500px; margin: auto; }
        h1 { color: #1a73e8; font-size: 1.2rem; margin: 10px 0; }
        
        /* æ˜ åƒã‚¨ãƒªã‚¢ */
        .video-container { width: 100%; background: #000; position: relative; overflow: hidden; border-radius: 10px; margin-bottom: 15px; display: none; }
        iframe { width: 100%; height: 56.25vw; border: none; display: block; }
        
        /* é€šçŸ¥ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: none; flex-direction: column;
            justify-content: center; align-items: center; z-index: 10; color: white;
        }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* æ“ä½œãƒ‘ãƒãƒ« */
        .control-row { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 8px; flex-wrap: wrap; }
        .control-label { font-size: 0.85rem; font-weight: bold; color: #1a73e8; min-width: 70px; text-align: right; }
        .btn-group { display: flex; gap: 5px; flex: 1; }
        
        button { padding: 12px; font-size: 14px; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        #startBtn { background-color: #34a853; color: white; width: 100%; }
        #stopBtn { background-color: #ea4335; color: white; width: 100%; margin-top: 20px; display: none; } /* åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º */
        .btn-cam { background: #673ab7; color: white; flex: 1; }
        .btn-servo { background: #607d8b; color: white; flex: 1; font-size: 11px; }
        .btn-refresh { background: #f4b400; color: white; width: 100%; margin-top: 10px; }
        
        .note { font-size: 11px; color: #666; margin-top: 15px; line-height: 1.4; padding: 0 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ  ç›£è¦–ã‚«ãƒ¡ãƒ©çµ±åˆãƒ‘ãƒãƒ«</h1>
        <div id="status" style="font-size: 12px; margin-bottom: 10px;">æ¥ç¶šä¸­...</div>

        <div id="videoWrapper" class="video-container">
            <div id="overlay">
                <div class="spinner"></div>
                <div id="overlayText">ç”»åƒãŒåˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™...</div>
            </div>
            <iframe id="mainPlayer" src=""></iframe>
        </div>

        <button id="startBtn">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã™ã‚‹</button>

        <div id="controls" style="display: none; margin-top: 15px;">
            <div class="control-row">
                <div class="control-label">ã‚«ãƒ¡ãƒ©åˆ‡æ›¿:</div>
                <div class="btn-group">
                    <button class="btn-cam" onclick="sendControl('SWITCH_CAM1')">ã‚«ãƒ¡ãƒ©ï¼‘</button>
                    <button class="btn-cam" onclick="sendControl('SWITCH_CAM2')">ã‚«ãƒ¡ãƒ©ï¼’</button>
                </div>
            </div>
            <div class="control-row">
                <div class="control-label">ã‚µãƒ¼ãƒœå‹•ä½œ:</div>
                <div class="btn-group">
                    <button class="btn-servo" onclick="sendServo(1)">å‹•ä½œ1(30Â°)</button>
                    <button class="btn-servo" onclick="sendServo(2)">å‹•ä½œ2(60Â°)</button>
                    <button class="btn-servo" onclick="sendServo(3)">å‹•ä½œ3(90Â°)</button>
                </div>
            </div>
            <button class="btn-refresh" onclick="refreshVideo()">â™»ï¸ æ˜ åƒå†èª­è¾¼ï¼ˆæ‰‹å‹•ï¼‰</button>
            
            <button id="stopBtn" onclick="stopWatching()">ã‚«ãƒ¡ãƒ©è¦–è´ã‚’çµ‚äº†ã™ã‚‹</button>
            
            <p class="note">âš ï¸ åŒã˜ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§è¦‹ã¦ã„ã‚‹äººãŒã‚«ãƒ¡ãƒ©åˆ‡æ›¿ã™ã‚‹ã¨ã€ã“ã¡ã‚‰ã®ã‚«ãƒ¡ãƒ©ã‚‚åˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™ã€‚</p>
        </div>
    </div>

    <script>
        const BROKER_URL = 'wss://x0a42d28.ala.asia-southeast1.emqxsl.com:8084/mqtt';
        const TOPIC_CONTROL = 'myneco/cam/maneki7/control';
        const TOPIC_URL = 'myneco/cam/maneki7/url_info';
        const SERVO_TOPIC = "rnubnxuhbtdjsm-un-siewuchtus-2026/nudjx";

        let isWatching = false;
        let streamUrl = "";
        let isMyOwnAction = false; 

        const client = mqtt.connect(BROKER_URL, { username: 'kanC', password: 'wMAdfBLkQiM2t9D' });
        const servoClient = mqtt.connect('wss://broker.emqx.io:8084/mqtt');

        client.on('connect', () => {
            document.getElementById('status').innerText = 'â— æ¥ç¶šå®Œäº†';
            client.subscribe(TOPIC_URL);
        });

        // ã‚«ãƒ¡ãƒ©èµ·å‹•ãƒœã‚¿ãƒ³ã®æŒ™å‹•
        document.getElementById('startBtn').onclick = () => {
            isWatching = true;
            client.publish(TOPIC_CONTROL, 'START_CAMERA');
            document.getElementById('startBtn').innerText = 'èµ·å‹•ä¿¡å·é€ä¿¡ä¸­...';
        };

        client.on('message', (topic, message) => {
            const data = message.toString();

            if (topic === TOPIC_URL) {
                if (data.startsWith('http')) {
                    streamUrl = data;
                    showVideo(data);
                    isMyOwnAction = false;
                } 
                else if (data === 'FORCE_RELOAD_START') {
                    if (!isMyOwnAction) {
                        showOverlay("ä»–ã®äººãŒæ“ä½œï¼ˆåˆ‡æ›¿/æ›´æ–°ï¼‰ä¸­ã§ã™...");
                    }
                }
            }
        });

        // æ˜ åƒã¨ã™ã¹ã¦ã®æ“ä½œãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
        function showVideo(url) {
            const ifr = document.getElementById('mainPlayer');
            ifr.src = url;
            
            // å„è¦ç´ ã®è¡¨ç¤ºãƒ»éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('videoWrapper').style.display = 'block';
            document.getElementById('controls').style.display = 'block'; // ãƒ‘ãƒãƒ«å…¨ä½“
            document.getElementById('stopBtn').style.display = 'block';  // çµ‚äº†ãƒœã‚¿ãƒ³
            document.getElementById('startBtn').style.display = 'none';   // èµ·å‹•ãƒœã‚¿ãƒ³
            
            hideOverlay();
        }

        function sendControl(cmd) {
            if (cmd.startsWith('SWITCH')) {
                isMyOwnAction = true; 
                showOverlay("ã‚«ãƒ¡ãƒ©åˆ‡æ›¿ä¸­...");
            }
            client.publish(TOPIC_CONTROL, cmd);
        }

        function refreshVideo() {
            isMyOwnAction = true;
            showOverlay("æ˜ åƒã‚’å†èª­è¾¼ä¸­...");
            
            client.publish(TOPIC_CONTROL, 'REFRESH_START');
            const ifr = document.getElementById('mainPlayer');
            ifr.src = ''; 
            setTimeout(() => { ifr.src = streamUrl; }, 500);
            
            setTimeout(() => { 
                if (isMyOwnAction) {
                    hideOverlay();
                    isMyOwnAction = false;
                }
            }, 2000);
        }

        function stopWatching() {
            if (!isWatching) return;
            isWatching = false;
            client.publish(TOPIC_CONTROL, 'STOP_CAMERA');
            
            // ãƒšãƒ¼ã‚¸ã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã™
            setTimeout(() => {
                location.reload();
            }, 500);
        }

        function showOverlay(text) {
            document.getElementById('overlayText').innerText = text;
            document.getElementById('overlay').style.display = 'flex';
        }

        function hideOverlay() {
            document.getElementById('overlay').style.display = 'none';
        }

        function sendServo(num) {
            servoClient.publish(SERVO_TOPIC, num.toString());
        }

        // ãƒ–ãƒ©ã‚¦ã‚¶ã‚„ã‚¿ãƒ–ã‚’é–‰ã˜ã‚‹éš›ã®ã‚«ã‚¦ãƒ³ãƒˆæ¸›å°‘å‡¦ç†
        window.addEventListener('beforeunload', () => {
            if (isWatching) client.publish(TOPIC_CONTROL, 'STOP_CAMERA');
        });
    </script>
</body>
</html>
