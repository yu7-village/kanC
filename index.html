<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›£è¦–ã‚«ãƒ¡ãƒ©ãƒ»ãƒªãƒ¢ã‚³ãƒ³</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background-color: #f0f2f5; }
        .container { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 400px; margin: auto; }
        h1 { color: #1a73e8; font-size: 1.5rem; }
        button { 
            width: 100%; padding: 15px; font-size: 1.2rem; font-weight: bold;
            border: none; border-radius: 8px; cursor: pointer; margin: 10px 0;
            transition: opacity 0.2s;
        }
        #startBtn { background-color: #34a853; color: white; }
        #stopBtn { background-color: #ea4335; color: white; }
        #status { margin: 20px 0; padding: 10px; border-radius: 5px; background: #eee; font-size: 0.8rem; word-break: break-all; }
        #linkArea { margin-top: 30px; }
        .view-link { 
            display: inline-block; padding: 20px; background: #1a73e8; color: white; 
            text-decoration: none; border-radius: 10px; font-weight: bold; animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ  ç›£è¦–ã‚«ãƒ¡ãƒ©ãƒ»ãƒªãƒ¢ã‚³ãƒ³</h1>
    <div id="status">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: æ¥ç¶šä¸­...</div>
    <button id="startBtn">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã™ã‚‹</button>
    <button id="stopBtn">ã‚«ãƒ¡ãƒ©ã‚’åœæ­¢ã™ã‚‹</button>
    <div id="linkArea"></div>
</div>

<script>
    // --- ã€è¨­å®šã‚¨ãƒªã‚¢ã€‘EMQX Cloudã®æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ ---
    const HOST = 'x0a42d28.ala.asia-southeast1.emqxsl.com'; // Overviewã§ç¢ºèªã—ãŸHostå (æœ«å°¾ã® :8084 ã¯å«ã‚ãªã„)
    const USERNAME = 'kanC';    // Authenticationã§ä½œæˆã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼å
    const PASSWORD = 'wMAdfBLkQiM2t9D';    // Authenticationã§ä½œæˆã—ãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰

    // ãƒˆãƒ”ãƒƒã‚¯è¨­å®š (PCå´ã® index.js ã¨å®Œå…¨ã«ä¸€è‡´ã•ã›ã¦ãã ã•ã„)
    const TOPIC_CONTROL = 'myneco/cam/maneki7/control'; 
    const TOPIC_URL     = 'myneco/cam/maneki7/url_info';

    // --- æ¥ç¶šå‡¦ç† ---
    const BROKER_URL = `wss://${HOST}:8084/mqtt`;
    
    const options = {
        username: USERNAME,
        password: PASSWORD,

        protocolVersion: 4,      // MQTT 3.1.1 (ãƒ–ãƒ©ã‚¦ã‚¶ã§ã®æ¨™æº–)
        clean: true,
        connectTimeout: 10000,   // 10ç§’å¾…æ©Ÿ
        clientId: 'web_' + Math.random().toString(16).substr(2, 8),
        // protocolId ãªã©ã®å¤ã„é …ç›®ã¯å‰Šé™¤ã—ã¾ã™
    };



    const client = mqtt.connect(BROKER_URL, options);

    const statusEl = document.getElementById('status');
    const linkArea = document.getElementById('linkArea');

    client.on('connect', () => {
        statusEl.innerText = 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: æ¥ç¶šå®Œäº†ï¼ˆæº–å‚™OKï¼‰';
        statusEl.style.background = '#e6f4ea';
        client.subscribe(TOPIC_URL);
    });

    client.on('error', (err) => {
        console.error('Connection error: ', err);
        statusEl.innerText = 'æ¥ç¶šã‚¨ãƒ©ãƒ¼: ' + err.message;
        statusEl.style.background = '#fce8e6';
    });

    document.getElementById('startBtn').onclick = () => {
        linkArea.innerHTML = 'URLç™ºè¡Œã‚’å¾…ã£ã¦ã„ã¾ã™...';
        client.publish(TOPIC_CONTROL, 'START_CAMERA');
    };

    document.getElementById('stopBtn').onclick = () => {
        linkArea.innerHTML = '';
        client.publish(TOPIC_CONTROL, 'STOP_CAMERA');
        statusEl.innerText = 'åœæ­¢å‘½ä»¤ã‚’é€ä¿¡ã—ã¾ã—ãŸ';
    };

    client.on('message', (topic, message) => {
        if (topic === TOPIC_URL) {
            const url = message.toString();
            statusEl.innerText = 'é…ä¿¡ä¸­ï¼';
            linkArea.innerHTML = `
                <p>æ˜ åƒã®æº–å‚™ãŒã§ãã¾ã—ãŸï¼š</p>
                <a href="${url}" target="_blank" class="view-link">ğŸ”´ æ˜ åƒã‚’è¦‹ã‚‹ï¼ˆåˆ¥ã‚¿ãƒ–ï¼‰</a>
            `;
        }
    });
</script>

</body>
</html>
